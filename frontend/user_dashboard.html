<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Music Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Styles for the modal */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="min-h-screen" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png');">
        <!-- Header -->
        <header class="bg-gray-900/50 backdrop-blur-sm shadow-lg sticky top-0 z-20">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
                    My Dashboard
                </h1>
                <div class="flex items-center space-x-4">
                    <span id="welcome-message" class="text-gray-300 hidden md:block">Welcome!</span>
                    <button id="logout-btn" class="bg-pink-600 hover:bg-pink-700 text-white text-sm font-bold py-2 px-4 rounded-full">
                        Logout
                    </button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column: User Profile -->
                <div class="lg:col-span-1">
                    <div class="glassmorphism rounded-2xl p-6 text-center">
                        <img id="profile-photo" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500 mx-auto mb-4" src="https://placehold.co/128x128/374151/a78bfa?text=U" alt="User profile photo">
                        <h2 id="profile-fullname" class="text-2xl font-bold">User Name</h2>
                        <p id="profile-email" class="text-gray-400">user@example.com</p>
                        <p id="profile-phone" class="text-gray-400 text-sm mt-1"></p>
                        
                        <button id="update-profile-btn" class="mt-4 text-sm text-purple-400 hover:underline">Update Profile</button>
                        
                        <a href="http://127.0.0.1:5000/generator" class="mt-6 inline-block w-full text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 focus:ring-4 focus:outline-none focus:ring-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                           Generate New Music
                        </a>
                    </div>
                </div>

                <!-- Right Column: Generated Songs -->
                <div class="lg:col-span-2">
                    <div class="glassmorphism rounded-2xl p-6">
                        <h3 class="text-2xl font-bold mb-6">My Generated Songs</h3>
                        <div id="song-list" class="space-y-4">
                            <!-- Songs will be dynamically inserted here -->
                            <p id="no-songs-message" class="text-gray-400">You haven't generated any songs yet. Click "Generate New Music" to start!</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Update Profile Modal -->
    <div id="update-modal" class="fixed inset-0 z-30 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="glassmorphism rounded-2xl shadow-lg p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center">Update Your Profile</h2>
            <form id="update-form">
                <div class="flex flex-col items-center mb-6">
                    <img id="update-photo-preview" class="w-24 h-24 rounded-full object-cover border-2 border-gray-600 mb-2" src="https://placehold.co/96x96/374151/a78bfa?text=Photo" alt="Profile preview">
                    <label for="update-photo-upload" class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-1 px-3 rounded-full">Change Photo</label>
                    <input id="update-photo-upload" type="file" class="hidden" accept="image/*">
                </div>
                <div class="mb-4">
                    <label for="update-fullname" class="block mb-2 text-sm font-medium text-gray-300">Full Name</label>
                    <input type="text" id="update-fullname" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="update-phone" class="block mb-2 text-sm font-medium text-gray-300">Phone Number</label>
                    <input type="tel" id="update-phone" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5">
                </div>
                <hr class="border-gray-600 my-6">
                <div class="mb-4">
                    <label for="current-password" class="block mb-2 text-sm font-medium text-gray-300">Current Password (to change password)</label>
                    <input type="password" id="current-password" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5">
                </div>
                <div class="mb-6">
                    <label for="new-password" class="block mb-2 text-sm font-medium text-gray-300">New Password</label>
                    <input type="password" id="new-password" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg block w-full p-2.5">
                </div>
                <div class="flex items-center justify-end space-x-4 mt-8">
                    <button type="button" id="cancel-update-btn" class="text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" class="text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Message container for non-modal messages -->
    <div id="message-container" class="fixed top-5 right-5 z-40"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // --- DOM Elements ---
            const welcomeMessage = document.getElementById('welcome-message');
            const profilePhoto = document.getElementById('profile-photo');
            const profileFullname = document.getElementById('profile-fullname');
            const profileEmail = document.getElementById('profile-email');
            const profilePhone = document.getElementById('profile-phone');
            const songList = document.getElementById('song-list');
            const noSongsMessage = document.getElementById('no-songs-message');
            const logoutBtn = document.getElementById('logout-btn');
            const updateProfileBtn = document.getElementById('update-profile-btn');
            const updateModal = document.getElementById('update-modal');
            const cancelUpdateBtn = document.getElementById('cancel-update-btn');
            const updateForm = document.getElementById('update-form');
            const messageContainer = document.getElementById('message-container');

            let newPhotoBase64 = null;

            // --- Helper Functions ---
            async function authenticatedFetch(url, options = {}) {
                options.credentials = 'include';
                const response = await fetch(url, options);
                if (response.redirected || response.status === 401) {
                    window.location.href = 'http://127.0.0.1:5000/';
                    return null;
                }
                return response;
            }

            function showToast(message, type) {
                const toast = document.createElement('div');
                toast.textContent = message;
                const baseClasses = 'px-4 py-2 rounded-md shadow-lg text-sm font-medium';
                const typeClasses = type === 'success' 
                    ? 'bg-green-500 text-white' 
                    : 'bg-red-500 text-white';
                toast.className = `${baseClasses} ${typeClasses}`;
                messageContainer.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // --- Main Data Loading ---
            async function loadDashboardData() {
                try {
                    const userResponse = await authenticatedFetch('http://127.0.0.1:5000/api/user');
                    if (!userResponse) return;
                    const userData = await userResponse.json();
                    
                    welcomeMessage.textContent = `Welcome, ${userData.fullname.split(' ')[0]}!`;
                    profileFullname.textContent = userData.fullname;
                    profileEmail.textContent = userData.email;
                    profilePhone.textContent = userData.phone || '';
                    if (userData.profile_photo) {
                        profilePhoto.src = userData.profile_photo;
                        document.getElementById('update-photo-preview').src = userData.profile_photo;
                    }
                    document.getElementById('update-fullname').value = userData.fullname;
                    document.getElementById('update-phone').value = userData.phone || '';

                    const songsResponse = await authenticatedFetch('http://127.0.0.1:5000/api/songs');
                    if (!songsResponse) return;
                    const songs = await songsResponse.json();

                    if (songs && songs.length > 0) {
                        noSongsMessage.style.display = 'none';
                        songList.innerHTML = '';
                        songs.forEach(song => {
                            const songElement = document.createElement('div');
                            songElement.className = 'bg-gray-800/50 p-4 rounded-lg flex items-center justify-between';
                            songElement.innerHTML = `
                                <div>
                                    <p class="font-semibold">${song.title}</p>
                                    <p class="text-xs text-gray-400">Generated on: ${song.date_created}</p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button class="preview-btn p-2 rounded-full bg-green-500 hover:bg-green-600 text-white" title="Preview"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg></button>
                                    <button class="delete-btn p-2 rounded-full bg-red-600 hover:bg-red-700 text-white" title="Delete" data-song-id="${song.id}"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.046.489 6.84a.75.75 0 00.732.709h3.5l.49 6.84a.75.75 0 00.732.709h.223a.75.75 0 00.732-.709l.49-6.84h3.5l.49 6.84a.75.75 0 00.732.709h.223a.75.75 0 00.732-.709l.49-6.84.149.046a.75.75 0 10.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75a1.25 1.25 0 00-1.25-1.25h-2.5A1.25 1.25 0 007.5 3.75v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 4.2a.75.75 0 101.5-.06l-.3-4.2zm4.84 0a.75.75 0 01-1.5.06l-.3 4.2a.75.75 0 111.5-.06l.3-4.2z" clip-rule="evenodd" /></svg></button>
                                </div>
                            `;
                            songList.appendChild(songElement);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }

            // --- Event Delegation for Song List ---
            songList.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.classList.contains('delete-btn')) {
                    const songId = target.dataset.songId;
                    if (confirm('Are you sure you want to delete this song?')) {
                        const response = await authenticatedFetch(`/api/songs/delete/${songId}`, { method: 'DELETE' });
                        if (response) {
                            showToast('Song deleted successfully.', 'success');
                            loadDashboardData(); // Refresh the list
                        } else {
                            showToast('Failed to delete song.', 'error');
                        }
                    }
                }
                // Add preview logic here if needed in the future
            });

            // --- Modal and Form Logic ---
            updateProfileBtn.addEventListener('click', () => updateModal.classList.remove('hidden'));
            cancelUpdateBtn.addEventListener('click', () => updateModal.classList.add('hidden'));
            
            document.getElementById('update-photo-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('update-photo-preview').src = event.target.result;
                        newPhotoBase64 = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            updateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const payload = {
                    fullname: document.getElementById('update-fullname').value,
                    phone: document.getElementById('update-phone').value,
                    current_password: document.getElementById('current-password').value,
                    new_password: document.getElementById('new-password').value,
                };
                if (newPhotoBase64) {
                    payload.profile_photo = newPhotoBase64;
                }

                const response = await authenticatedFetch('/api/user/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response) {
                    const result = await response.json();
                    if (response.ok) {
                        showToast(result.message, 'success');
                        updateModal.classList.add('hidden');
                        loadDashboardData(); // Refresh profile info
                    } else {
                        showToast(result.message, 'error');
                    }
                }
            });

            logoutBtn.addEventListener('click', async () => {
                await authenticatedFetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            });

            // --- Initial Load ---
            loadDashboardData();
        });
    </script>
</body>
</html>
